"use strict";var gulp=require("gulp"),plugins=require("gulp-load-plugins")(),runSequence=require("run-sequence"),watchify=require("watchify"),browserify=require("browserify"),uglifyify=require("uglifyify"),mergeStream=require("merge-stream"),source=require("vinyl-source-stream"),buffer=require("vinyl-buffer"),babelify=require("babelify"),browserSync=require("browser-sync"),reload=browserSync.reload;function createBundler(e){var r;return(r=plugins.util.env.production?browserify():browserify({cache:{},packageCache:{},fullPaths:!0,debug:!0})).transform(babelify.configure({stage:1})),plugins.util.env.production&&r.transform({global:!0},"uglifyify"),r.add(e),r}function bundle(e,r){var u=r.split("/"),i=u[u.length-1],n=u.slice(0,-1).join("/");return e.bundle().on("error",plugins.util.log.bind(plugins.util,"Browserify Error")).pipe(source(i)).pipe(buffer()).pipe(plugins.sourcemaps.init({loadMaps:!0})).pipe(plugins.sourcemaps.write("./")).pipe(plugins.size({gzip:!0,title:i})).pipe(gulp.dest("dist/"+n)).pipe(reload({stream:!0}))}gulp.task("clean",function(e){require("del")(["dist"],e)}),gulp.task("copy-lib",function(){return gulp.src(["lib/idb.js"]).pipe(gulp.dest("dist")).pipe(reload({stream:!0}))}),gulp.task("copy",function(){return gulp.src(["test/index.html","node_modules/mocha/mocha.css","node_modules/mocha/mocha.js"]).pipe(gulp.dest("dist/test")).pipe(reload({stream:!0}))});var bundlers={"test/idb.js":createBundler("./test/idb.js")};gulp.task("js",function(){return mergeStream.apply(null,Object.keys(bundlers).map(function(e){return bundle(bundlers[e],e)}))}),gulp.task("browser-sync",function(){browserSync({notify:!1,port:8e3,server:"dist",open:!1})}),gulp.task("watch",function(){gulp.watch(["test/index.html"],["copy"]),gulp.watch(["lib/idb.js"],["copy-lib"]),Object.keys(bundlers).forEach(function(e){var r=watchify(bundlers[e]);r.on("update",function(){return bundle(r,e)}),bundle(r,e)})}),gulp.task("build",function(e){runSequence("clean",["copy","js","copy-lib"],e)}),gulp.task("default",["build"]),gulp.task("serve",function(e){runSequence("clean",["copy","js","copy-lib"],["browser-sync","watch"],e)});